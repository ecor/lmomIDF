---
title: "Mapping extreme storm events with Intensity-Duration-Frequency (IDF) using spatially gridded datasets"
author: "Emanuele Cordano"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"Mapping extreme storm events with Intensity-Duration-Frequency (IDF) using spatially gridded datasets"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: bibliography.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo=TRUE,
  warning = FALSE
)
###knitr::opts_chunk$set(echo = TRUE)
```


<!-- --- -->
<!-- title: "Untitled" -->
<!-- output: github_document -->
<!-- bibliography: bibliography.bib -->

<!-- --- -->
## CHIRPS datasets and its APIs in R 

Climate Hazards Group InfraRed Precipitation with Station data (CHIRPS) (@Funk2015) is a 30+ year quasi-global rainfall dataset. Spanning 50 deg S-50 degN (and all longitudes), starting in 1981 to near-present, CHIRPS incorporates 0.05° resolution satellite imagery with in-situ station data to create spatially gridded rainfall time series for trend analysis and seasonal drought monitoring. It provides daily, monthly, pentadal, and decadal temporal rainfall resolution registers with a spatial resolution of 0.05° (∼5.3 km), and quasi-global coverage (within 50°S, 50°N, 180°W, and 180°E).  The U.S. Geological Survey and the Climate Hazards Group at the University of California in Santa Barbara and observations from the Climate Prediction Center and the National Climatic Data Center were involved in developing the CHIRPS dataset. Rainfall estimations are created from two thermal infrared satellite observation archives using the cold cloud duration. Their calibration process uses the TRMM and in situ observations of precipitation (@Funk2015,@Funk2015essd72752015). 
It has been working from 1981 to the present day, and is mainly used to study drought (@Funk2014).
CHIRPS dataset is available from https://www.chc.ucsb.edu/data/chirps/.
For statistical analysis performed by R, like in this vignette, daily values by CHIRPS data can be downloaded and imported directly into the R environment through the specific **chirps** R package (@deSousa2020) working as an API:

```{r chirps,fig.width=7}

## remotes::install_github("ropensci/chirps")
## 
library(chirps)
library(sf)
library(magrittr)
library(terra)
library(stringr)
##
##

xmin <- 29
ymin <- 25
xmax <- 37
ymax <- 32

r <- rast(xmin=xmin, xmax=xmax, 
          ymin=ymin, ymax=ymax,crs="epsg:4326",resolution=1)

r[] <- 0
mapview::mapview(raster::raster(r),alpha=0.2)
## view with leaflet:: see ..

years <- 1982:2021
chirps_filenames <- "/home/ecor/local/data/climate/jrc/lmomIDF_example_ext_data/chirps_test_area/chirps_%d.grd" %>% sprintf(years)
cond0 <- FALSE ## current set to be FALSE please set TRUE not to trigger possible CHIRPS data download

for (year in years) {

  dates <- c("%d-01-01","%d-12-31") %>% sprintf(year,year)
  filename <- chirps_filenames[years==year]
  cond <- !file.exists(filename) | cond0
  if (cond) {
    ss <- system.time({
  ## chirps R package Version 0.1.5
  
      chirps <- get_chirps(r,dates=dates,server="CHC")
  
      chirps[chirps<0] <- NA
  
      terra::time(chirps) <- seq(from=as.Date(dates[1]),to=as.Date(dates[2]),by=1)
  
    
  
      writeRaster(chirps,filename=filename,overwrite=TRUE) 
    })
  }
}

## PUT A MAP HERE
```
Annual maxima with duration from 1 to 5 days are extracted:

```{r chirps.max,fig.width=7,fig.height=8}

prec_data <- rast(chirps_filenames)

annual.agg.wrap <- function(x,time,...,numeric_dd= FALSE,aggr.name="aggr",dd.name="dd", index.name = "index") { 
  out1 <- annual.agg(x,time,aggr.name=aggr.name,dd.name=dd.name,index.name=index.name,numeric_dd=numeric_dd,...)
  out1 <- as.data.frame(out1)
  out <- out1[,aggr.name]
  names(out) <- paste(out1[,dd.name],out1[,index.name],sep="_")
  return(out)
  }
cond1 <- FALSE ## current set to be FALSE please set TRUE to trigger possible CHIRPS data download
aggr_filename <- "/home/ecor/local/rpackages/jrc/lmomIDF/inst/ext_data/chirps_test_area_aggr/chirps_annual_maxima_v01.grd"

cond <- !file.exists(aggr_filename) | cond1
if (cond) {
##
  ss <- system.time({
    ##out0aggr <- app(prec_data,fun=annual.agg.wrap,time=time(prec_data),filename=aggr_filename,overwrite=TRUE)
    out0aggr <- app(prec_data,fun=annual.agg,time=time(prec_data),return_vector=TRUE,filename=aggr_filename,overwrite=TRUE)
  })
} else {
  
  
  out0aggr <- rast(aggr_filename)
}
###
out0aggr[out0aggr<0] <- NA ## Mandatory
time(out0aggr,tstep="years") <- str_split(names(out0aggr),"_") %>% sapply(FUN=function(x){x[2]}) %>% as.numeric()
units(out0aggr) <- "mm day -1"
varnames(out0aggr) <- "Rainfall Intensity"
##varnames(out0aggr) <-  str_split(names(out0aggr),"_") %>% sapply(FUN=function(x){x[1]})
###
plotting_years <- c(1985,1995,2005,2015)
nn <- names(out0aggr)
ll <- unlist(lapply(nn,FUN=function(x,y=plotting_years){return(x[any(str_detect(x,as.character(y)))])}))
###

library(RColorBrewer)
library(tidyterra)
library(ggplot2)
col1 <- brewer.pal(name="YlGnBu",n=10) %>% col2rgb()
col2 <- brewer.pal(name="YlOrRd",n=10) %>% rev() %>% col2rgb()
coll <- (col1*0.3+col2*0.7)/255
##coll[,] <- as.integer(coll[,]) 
colz <- rgb(red=coll["red",],green=coll["green",],blue=coll["blue",],maxColorValue = 1) %>% rev()
#plot(out0aggr[[ll]],col=colz)
## https://bookdown.org/igisc/EnvDataSci/spatial-data-and-maps.html

aggr_to_plot <- out0aggr[[ll]]
aggr_to_plot[aggr_to_plot>400] <- NA
##https://cran.r-project.org/web/packages/tidyterra/vignettes/tidyterra.html

##https://cran.r-project.org/web/packages/tidyterra/vignettes/tidyterra.html
nrow <- length(unique(time(aggr_to_plot)))
mm <- matrix(names(aggr_to_plot),nrow=nrow) %>% t() 
gg <- ggplot()+geom_spatraster(data = aggr_to_plot[[mm]])+facet_wrap(~lyr,nrow=nrow)+theme_bw()
##gg <- gg + scale_fill_continuous(type = "viridis")



ff <- function(x,colors=colz,values=aggr_to_plot[],probs=(0:10)/100,...) {
  x <- x[]
  df <- data.frame(prob=probs)
  df$color <- colorRampPalette(colors)(nrow(df))
  df$value <- quantile(values,probs=df$prob,type=3,na.rm=TRUE) ## sse help(quantile)
   ###summary(quantile(probs=ecdf(values_)(values_),values_,type=3)-values_)
  qq <- ecdf(values)(x)
  
  out <- colorRamp(colors,...)(qq)
  outt <<- out
 out2 <- rgb(red=out[,1],green=out[,2],blue=out[,3],maxColorValue=255)
  
  
  return(out2)
}

##gg <- gg + scale_fill_continuous(type =  ff)

#gg <- gg + scale_fill_continuous(type =  colorRampPalette(colz)(10))
xvv <- 0:300
gg <- gg+scale_fill_gradientn(colors=ff(0:300),name="Precipitation Intensity [mm/day]")

#gg <- gg+scale_fill_gradientn(palette=colorRampPalette(colz))
##gg <- ggplot() +geom_spatraster(data = aggr_to_plot,aes(group=lyr))+facet_grid(lyr ~ .time)+theme_bw()
##gg <- gg+scale_fill_gradient(low="blue", high="red")
## http://www.sthda.com/english/wiki/ggplot2-colors-how-to-change-colors-automatically-and-manually
gg

```

Here is an interactive map:

```{r plet,fig.width=7,fig.height=10}
## plet(x, 1:2, tiles=c("Streets", "Esri.WorldImagery", "OpenTopoMap")[3], collapse=FALSE) |> lines(v, lwd=2, col="blue")
library(leaflet)
out1aggr  <- out0aggr
out1aggr[out1aggr>400] <- NA
plet(out1aggr,1:nlyr(out0aggr), tiles=c("Streets", "Esri.WorldImagery", "OpenTopoMap")[2], collapse=FALSE,shared=TRUE,legend="bottomleft") %>% addScaleBar() #%>% lines(v, lwd=2, col="blue")  #%>% lines(v, lwd=2, col="blue") 

```


Results show a straight line  between Arabian Peninsula and the southern point of Sinai Peninsula. Along this line, variation amomng adjacent cells look unrealistic and can be difficulty assumed as real. Most probably, it would be due to an error in the spatial interpolation, in a biniding the results of two moving windows regression area (@Funk2015essd72752015)

### IDF and L-moment estimation 

Assuming a reference period from 1981 to 2010, L-moments are computed as follows (@Hosking20219lmom), in particular the first and second abosolute L-Momements  $l_1$ and $l_2$ are:

```{r ann.max.samlum.1981.2010,fig.width=7, paged.print=FALSE,eval=TRUE}

library(lmomIDF)
library(terra)

lmom_filename <-  "/home/ecor/local/rpackages/jrc/lmomIDF/inst/ext_data/chirps_test_area_aggr/chirps_annual_maxima_lmom_v01.grd"
cond_lmom <- FALSE
cond_lmom <- !file.exists(lmom_filename) | cond_lmom
##cond_lmom <- TRUE
if (cond_lmom) {
  lmom_map <- app(out0aggr,fun=annual.agg.idf.samlmu,like_lmom=FALSE,use_ggplot=FALSE,filename=lmom_filename,overwrite=TRUE,nmom=5)
} else {
  
  
  lmom_map <- rast(lmom_filename)

}

## CHECK L-MOMENT VALIDITY with "lmomco" package
library(lmomco)
lmom_valid <- app(lmom_map,fun=function(x){are.lmom.valid(vec2lmom(x[1:5]))})
## check lmom_map[(lmom_valid!=1) & !(is.na(lmom_map[[1]])) & !(is.na(lmom_map[[2]]))]
## correction: 
#lmom_map[(lmom_valid!=1) & !(is.na(lmom_map[[1]])) & !(is.na(lmom_map[[2]]))] <- NA
lmom_map[(lmom_valid!=1)] <- NA
####

gl  <- ggplot()+geom_spatraster(data = lmom_map[[c("l_1","l_2")]])+facet_wrap(~lyr)+theme_bw()
gl
```
The third and fourth re-scaled L-Moments, $t_3$ and $t_4$  (@Hosking20219lmom):


```{r ann.max.samlum.1981.2010_t3_t4,fig.width=7, paged.print=FALSE,eval=TRUE}
gt3  <- ggplot()+geom_spatraster(data = lmom_map[[c("t_3","t_4")]])+facet_wrap(~lyr)+theme_bw()
gt3
```

Finally, the exponent $n$ (@Monjo2009@Monjo2016) of power-law IDF curves (e.g. @Koutsoyiannis1998,@Monjo2009,@DePaola2014,@Mirhosseini2013,@Markiewicz2021,@idfcurveswiki) is (IDF curves estimated with storm event of 1,2 and 5 days duration): 

```{r ann.max.samlmu.1981.2010_n_idf,fig.width=7, paged.print=FALSE,eval=TRUE}

sp_n_idf <- lmom_map[[c("n_idf")]]
sp_p_idf <- lmom_map[[c("p_idf")]]
sp_n_ddf <- lmom_map[[c("n_ddf")]]
sp_p_ddf <- lmom_map[[c("p_ddf")]]   

sp2_n_idf <- sp_n_idf       
sp2_n_idf[sp_p_ddf>0.1] <- -1              
gn <- ggplot()+geom_spatraster(data = sp2_n_idf)+facet_wrap(~lyr)+theme_bw()
gn


```


According to @Monjo2016 , being the exponent $n$ between -0.6 and -1  ($-0.6 \leq n<-1$) reveals the storm events in the study region are higly irregularly with rapid  evolution n (e.g. showers,
thunderstorms, etc.).

```{r ann.max.samlmu.1981.2010_p_ddf,fig.width=7, paged.print=FALSE,eval=TRUE}

     
gpvd <- ggplot()+geom_spatraster(data = sp_p_ddf)+facet_wrap(~lyr)+theme_bw()
gpvd


```

Finally, the values of precipitation maxima at the different durations are fitted with the GEV probability distributions (@gevwiki) with parameters derived by the estimated L-moments trhrough the IDF curves. 
The analysis is performed by transforming the *SpatRaster* objects defined within  **terra** R package (@terraRpackage) into the RasterStack ones defined in **raster** R package (@rasterRpackage) in order to make use of **rasterList** package (@rasterListRPackage) .
Therefore the goodness of fit for each verification is verified with a Kolgomorov-Smirnov test (@Marsaglia2003). 

```{r ann.max.samlmu.1981.2010_gev_param,fig.width=7, paged.print=FALSE,eval=TRUE}


library(raster)
library(rasterList) ## RasterList >= 0.5.15
library(stringr)

distrib="gev"


ddd <- sapply(str_split(names(out0aggr),"_"),function(w){w[1]}) %>% unique() %>% str_replace_all("[A-Z]","") %>% str_replace_all("[a-z]","") %>% as.numeric()
lmom_rl <- stack(lmom_map) %>% rasterList(FUN=function(x,dd=ddd,pv=0.1,dd.name="dd"){ 
    n_idf <- x["n_idf"]
    n_idf[x["p_ddf"]>pv] <- (-1)
    out <- data.frame(dd=dd) 
    names(out)[names(out)=="dd"] <- dd.name
    for (it in c("l_1","l_2")) {
      
      out[,it] <- x[it]*out[,dd.name]^n_idf
      
    } 
    for (it in c("t_3","t_4")) {
      
      
      out[,it] <- x[it]
    }  
    
    return(out)
    
  })


gev_para <- RasterListApply(x=rasterList(stack(out0aggr)),lmom=lmom_rl,FUN=annual.agg.pel,distrib="gev") 

gev_pvalue <- stack(gev_para,FUN=function(x,dd_formatter="D%03d",dd.name="dd") {
  ou2 <- attr(x,"lmom")
  if (!is.data.frame(ou2)) {
    ou3 <- NULL
  } else {
    ou3 <- ou2$p.value
    names(ou3) <- sprintf(dd_formatter,ou2[,dd.name])
  }
  return(ou3)
  }) %>% rast()

gpv_gev <- ggplot()+geom_spatraster(data = gev_pvalue)+facet_wrap(~lyr)+theme_bw()
gpv_gev



```
Test acceptance ($p>0.1$) for each duration category:

```{r ann.max.samlum.1981.2010_gev_param_test_passed,fig.width=7, paged.print=FALSE,eval=TRUE}


gev_pvalue_passed <- gev_pvalue>0.1

gpv_gev_passed <- ggplot()+geom_spatraster(data = gev_pvalue_passed)+facet_wrap(~lyr)+theme_bw()
gpv_gev_passed


```


Test acceptance ($min(p)>0.1$) for all duration categories:


```{r ann.max.samlum.1981.2010_gev_param_test_passed2,fig.width=7, paged.print=FALSE,eval=TRUE}


gev_pvalue_passed2 <- min(gev_pvalue)>0.1
gev_gev_passed2 <- ggplot()+geom_spatraster(data = gev_pvalue_passed2)+theme_bw()
gev_gev_passed2


```

Finally, quantiles of maximum precipitation referred to specific return periods can be estimated as follows:


```{r ann.max.samlum.1981.2010_qua,fig.width=7, ,fig.height=10,paged.print=FALSE,eval=TRUE}




library(raster)
rt <- c(2,5,10,20,50,100,200)


f <- 1-1/rt ##c(0.5,0.9)
gev_qua_rl <- rasterList(gev_para,FUN=annual.agg.qua,f=f,use_ggplot=FALSE,possible_return_null=TRUE) ###    (f=f,para=z,use_gglopt=FALSE)
gev_qua <- stack(gev_qua_rl,FUN=df2vec,index.name="f") %>% rast()

####
gev_qua[!gev_pvalue_passed2] <- NA
####

nrow <- length(f)
mm <- matrix(names(gev_qua),nrow=nrow) %>% t() 
ggqua <- ggplot()+geom_spatraster(data = gev_qua[[mm]])+facet_wrap(~lyr,nrow=nrow)+theme_bw()
##xvv <- 0:300
##gg <- gg+scale_fill_gradientn(colors=ff(0:300),name="Precipitation Intensity [mm/day]")
ggqua



```

Visualitazion as a web ma through *terra::plet* (@terraRpackage): 


```{r ann.max.samlum.1981.2010_qua_plet,fig.width=7, ,fig.height=10,paged.print=FALSE,eval=TRUE}

library(leaflet)



gev1_qua  <- gev_qua
gev1_qua[gev1_qua>400] <- NA

ff2 <- function(x,colors=colz,values=gev1_qua[],probs=(0:10)/100,...) {
  x <- x[]
  df <- data.frame(prob=probs)
  df$color <- colorRampPalette(colors)(nrow(df))
  df$value <- quantile(values,probs=df$prob,type=3,na.rm=TRUE) ## sse help(quantile)
   ###summary(quantile(probs=ecdf(values_)(values_),values_,type=3)-values_)
  qq <- ecdf(values)(x)
  
  out <- colorRamp(colors,...)(qq)
  outt <<- out
 out2 <- rgb(red=out[,1],green=out[,2],blue=out[,3],maxColorValue=255)
  
  
  return(out2)
}







plet(gev1_qua,1:nlyr(gev1_qua), tiles=c("Streets", "Esri.WorldImagery", "OpenTopoMap")[2], collapse=FALSE,shared=TRUE,legend="bottomleft") ##,col=ff2) %>% addScaleBar() #%>% lines(v, lwd=2, col="blue") 


```


# Conclusions and the way forward.


The vignette presents a procedure to create for the estimated return periods of precipitation with the method of IDF curves coupled with L-Moments. Results shows the presence of the highly irregular events with rapid evolution and can be around 120 mm/day with a return period of 20 years (duration 1 day)  in the highland areas and 
greater than 200 mm/day with a return period of 200 (duration 1 day)  in some highland areas (e.g. Sinai peninsula). The return periods are estimated through the GEV (Genaralized Extreme Value) probability distribution.  
In several widespread cells the probability distribution fitting performed through a Kolgormov-Smirnov test, do not pass ($p$-value $<0.1$)  . These cells contain *NA* values.  Further investigations are addressed to understand which $NA$-value cells are "false" positive (type I error), in case of spatial stationarity and ergodicity, $10%$ of false positive can be expected, or biases due to other properties (e.g. in the Nile delta area).



# Further Material

Further useful contents with URLs and/or link to documents are: 

- https://cran.r-project.org/web/views/ExtremeValue.html or https://github.com/cran-task-views/ExtremeValue/ ;

- https://aquaknow.jrc.ec.europa.eu/en/acewater2-jrc-nepad-sanwatce-nepad-ceanwatce-nepad-wanwatce/dataset/daily-chirps-precipitation ;

- https://climateknowledgeportal.worldbank.org/country/saudi-arabia/extremes ;

- https://climateknowledgeportal.worldbank.org/country/egypt/extremes

The list and URLs and/or references will be further updated.




# References 


```{r generateBibliography,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hide"}

require(knitcitations)
cleanbib()
options(citation_format="pandoc")
read.bibtex(file = "bibliography.bib")


```


