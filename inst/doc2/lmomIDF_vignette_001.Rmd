---
title: "Vignette Title"
author: "Emanuele Cordano"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: bibliography.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo=TRUE,
  warning = FALSE
)
###knitr::opts_chunk$set(echo = TRUE)
```


<!-- --- -->
<!-- title: "Untitled" -->
<!-- output: github_document -->
<!-- bibliography: bibliography.bib -->

<!-- --- -->

## Intensity-Duration-Frequency Curve (IDF)


Intensity-duration-frequency (IDF) curves usefully quantify extreme precipitation over various duration, e.g. from 1 to 360 hours,  and return periods for engineering design, e.g. the interest in the time concentration or time-structure of the rainfall.  (e.g. @Courty2019,@Sun2019)
Among the different mathematical formulations used in literature (CCC), the most commomt and used here in thiss package is  the following (@Koutsoyiannis1998): 
<!--\qquad {-b \pm \sqrt{b^2-4ac} \over 2a} $$ -->
$$ I =  a(T) D^{n} $$ 
where $I$ is precipitation intensity [mm/hr or mm/day] , $D$ is the duration of the extreme precipitation (storm) event, and $a(T)$ is a coefficient depending on return period  $T$ or probability/frequency $f$ (where $f=1-{1 /over T$ where studying storm and flood events) and $n$ is an exponent assumed to be constant. The key concepts behind this theory are they: 

- precipitation duration depth ($I \cdot D$) with a fixed return period and a short duration cannot be higher than the depth of an event with a longer duration and the same return period; 

- Probability distribution of annual maximum precipitation average intensity maintains constant properties (e.g.  parametric definition) for different event time duration only some moments or parameters are scaled with duration.

Therefore annual maxima precipitation are collected from daily  or hourly time series; for each duration a probability distributions (e.g. a GEV distribution) is fitted though a Maximum Likelihood Method or a L-Moment Method; fitting is verified with a statistical test (e.g. Kolgorov-Smirnov test); some moments and/or parameter are scaled with duration through a regression (e.g. a log-LM model); a probability distribution with new moments' and parameters' values is estimated for each duration; it can be tested versus original maxima time series.
Recently, @Heidari2020 extend also the concepts of IDF curves to droughts. This aspect can be used in this package but requires further investigations. 



## An application with GSOD dataset

Here is an application of use of the packege with GSOD precipitation data through GSODR package (@Sparks2017) to get (and work with) daily precipitation time series recerder in Alexandria International Airport, Egypt. 

```{r gsod}

library(GSODR)
library(dplyr)
library(magrittr)
years <- 1937:2020
gsod_rds <- "/home/ecor/local/rpackages/jrc/lmomIDF/inst/ext_data/gsod.rds"
cond <- file.exists(gsod_rds) 
if (!cond) {
  gsod <- get_GSOD(years=years,station="623180-99999") ##ALEXANDRIA INTL EG 623180-99999
  saveRDS(gsod,file=gsod_rds)  
} else {
  gsod <- readRDS(file=gsod_rds)
}

#####
#####

prec <- gsod %>% select(YEARMODA,PRCP,PRCP_ATTRIBUTES) %>%
 mutate(YEARMODA=as.Date(YEARMODA,format="%Y-%m-%d")) 

knitr::kable(rbind(head(prec),tail(prec)))

### Dataset preparation 
## insertion of rows so that all instants are equidistant (i.e. there is a constant time step) 
## inserting any NA values of precipitation intensity


dds <- range(prec$YEARMODA)
## See GSODR documentation
yymmdds <- seq(from=dds[1],to=dds[2],by="day")
prec <- data.table::data.table(YEARMODA=yymmdds) %>% full_join(prec)



```



## Precipitation Time Series

Time series can be visualized as follows: 

```{r gsod_zoo, fig.width=7, paged.print=FALSE}

library(zoo)
library(dygraphs)

time <- prec$YEARMODA
precz <- prec$PRCP %>% as.zoo()
index(precz) <- time
main="DAILY PRECIPITATION Vs TIME"
ylab="precipitation [mm/hr]"
xlab="time"

dd <- dygraph(precz,main=main,ylab=ylab,xlab=xlab) %>% dyRangeSelector()
dd


```

## Annual Maxima for fixed duration 

Annual maxima with duration from 1 to 5 days are extracted:

```{r ann.max,fig.width=7, paged.print=FALSE}

library(lmomIDF)
library(lubridate)


ann.maxima <- annual.agg(x=prec$PRCP,time=prec$YEARMODA,aggr.fun=max,dd=1:5)
### values cannot be -Inf or +Inf
ann.maxima$aggr[ann.maxima$aggr==-Inf] <- NA
###
str(ann.maxima)
###
ann.maxima.z <- ann.maxima %>% reshape2::dcast(index ~ dd)
time <- as.numeric(ann.maxima.z$index)
ann.maxima.z <- ann.maxima.z %>% select(-index) %>% as.zoo()
time1 <- as.Date("1980-01-01")
year(time1) <- time
index(ann.maxima.z) <- time1 


main="MAXIMUM PRECIPITATION INTENSITY Vs TIME"
ylab="precipitation intensity [mm/hr]"
xlab="time"

dda <- dygraph(ann.maxima.z,main=main,ylab=ylab,xlab=xlab) %>% dyRangeSelector()
dda
```

## Study Period: 1981-2010  
### L-moment estimation 

Assuming a reference period from 1981 to 2010, L-moments are computed as follows (@Hosking20219lmom):

```{r ann.max.samlum.1981.2010,fig.width=7, paged.print=FALSE}

x <- ann.maxima %>% filter(as.numeric(index) %in% 1980:2010) 
lmom <- annual.agg.samlmu(x)

head(lmom)

```
### GEV fitting

Through L-Moments , GEV probability distribution parameter were estimated:

```{r ann.max.pel.1981.2010,fig.width=7, paged.print=FALSE}

para <- annual.agg.pel(distrib="gev",x=x,lmom=lmom)

para$D001
attr(para,"lmom")


```
### IDF curve (1981-2010)

Regressing logarithms the absolute 1nd and 2rd L-moments with the logarithm of duration, it comes out: 

```{r ann.max.qua.1981.2010,fig.width=7, paged.print=FALSE}


lmom_idf <- annual.agg.idf.samlmu(x,lmom=attr(para,"lmom"))
####
summary(attr(lmom_idf,"fit"))
####
attr(lmom_idf,"gg")

```

A IDF relations like $I =  a(T) D^{n}$, where $n$ is estimated to be `r signif(attr(lmom_idf,"n_idf"),5)`, has been assed:  

```{r ann.max.idf.pel.1981.2010,fig.width=7, paged.print=FALSE}
para_idf_1981_2010 <- annual.agg.pel(distrib="gev",x=x,lmom=lmom_idf)

para_idf_1981_2010$D001
attr(para_idf_1981_2010,"lmom")
 
```

*p.values* of Kolgormov-Smirov's test present values greater than `signif(min(attr(para_idf,"lmom")$p.value),2)-0.01`.
Here is boxplot of precipitation intensity versus duration with IDF curves for some return periods (e.g. 2,5,10,...,100,... years)(legend reports frequacies/probailities $f$ defined as $f=1- {1 \over T}$ with $T$ return periods):
```{r ann.max.idf.qua.1981.2010,fig.width=7, paged.print=FALSE}

set.seed(560)
rt <- c(2,5,10,20,50,100,200,500)
f  <- 1-1/rt
##f=c(0.5,0.8,0.9,0.95,0.98,0.99,0.999,0.9999)
out_qua_1981_2010 <- annual.agg.qua(f=f,para=para_idf_1981_2010,remove_distrib_from_boxplot=TRUE)
attr(out_qua_1981_2010,"idf")
 
```
And the analogous plot resenting precipitation depth with DDF (Depth-Duration-Frequacy) curve : 
```{r ann.max.idf.qua.depth.1981.2010,fig.width=7, paged.print=FALSE}

attr(out_qua_1981_2010,"ddf")
 
```












## Study Period: 1991-2020  
### L-moment estimation 

Assuming a reference period from 1991 to 2020, L-moments are computed as follows (@Hosking20219lmom):

```{r ann.max.samlum.1991.2020,fig.width=7, paged.print=FALSE}

x <- ann.maxima %>% filter(as.numeric(index) %in% 1980:2020) 
lmom <- annual.agg.samlmu(x)

head(lmom)

```
### GEV fitting

Through L-Moments , GEV probability distribution parameter were estimated:

```{r ann.max.pel.1991.2020,fig.width=7, paged.print=FALSE}

para <- annual.agg.pel(distrib="gev",x=x,lmom=lmom)

para$D001
attr(para,"lmom")


```
### IDF curve (1991-2020)

Regressing logarithms the absolute 1nd and 2rd L-moments with the logarithm of duration, it comes out: 

```{r ann.max.qua.1991.2020,fig.width=7, paged.print=FALSE}


lmom_idf <- annual.agg.idf.samlmu(x,lmom=attr(para,"lmom"))
####
summary(attr(lmom_idf,"fit"))
####
attr(lmom_idf,"gg")

```

A IDF relations like $I =  a(T) D^{n}$, where $n$ is estimated to be `r signif(attr(lmom_idf,"n_idf"),5)`, has been assed:  

```{r ann.max.idf.pel.1991.2020,fig.width=7, paged.print=FALSE}
para_idf_1991_2020 <- annual.agg.pel(distrib="gev",x=x,lmom=lmom_idf)

para_idf_1991_2020$D001
attr(para_idf_1991_2020,"lmom")
 
```

*p.values* of Kolgormov-Smirov's test present values greater than `signif(min(attr(para_idf,"lmom")$p.value),2)-0.01`.
Here is boxplot of precipitation intensity versus duration with IDF curves for some return periods (e.g. 2,5,10,...,100,... years)(legend reports frequacies/probailities $f$ defined as $f=1- {1 \over T}$ with $T$ return periods):
```{r ann.max.idf.qua.1991.2020,fig.width=7, paged.print=FALSE}

set.seed(560)
rt <- c(2,5,10,20,50,100,200,500)
f  <- 1-1/rt
##f=c(0.5,0.8,0.9,0.95,0.98,0.99,0.999,0.9999)
out_qua_1991_2020 <- annual.agg.qua(f=f,para=para_idf_1991_2020,remove_distrib_from_boxplot=TRUE)
attr(out_qua_1991_2020,"idf")
 
```
And the analogous plot resenting precipitation depth with DDF (Depth-Duration-Frequacy) curve : 
```{r ann.max.idf.qua.depth.1991.2020,fig.width=7, paged.print=FALSE}

attr(out_qua_1991_2020,"ddf")
 
```





















## References 


```{r generateBibliography,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hide"}

require(knitcitations)
cleanbib()
options(citation_format="pandoc")
read.bibtex(file = "bibliography.bib")


```
















<!-- ## START VIGNETTE TEMPLATE -->

<!-- Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format: -->

<!-- - Never uses retina figures -->
<!-- - Has a smaller default figure size -->
<!-- - Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style -->

<!-- ## Vignette Info -->

<!-- Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette. -->

<!-- ## Styles -->

<!-- The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows: -->

<!--     output:  -->
<!--       rmarkdown::html_vignette: -->
<!--         css: mystyles.css -->

<!-- ## Figures -->

<!-- The figure sizes have been customised so that you can easily put two images side-by-side.  -->

<!-- ```{r, fig.show='hold'} -->
<!-- plot(1:10) -->
<!-- plot(10:1) -->
<!-- ``` -->

<!-- You can enable figure captions by `fig_caption: yes` in YAML: -->

<!--     output: -->
<!--       rmarkdown::html_vignette: -->
<!--         fig_caption: yes -->

<!-- Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**. -->

<!-- ## More Examples -->

<!-- You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`. -->

<!-- ```{r, echo=FALSE, results='asis'} -->
<!-- knitr::kable(head(mtcars, 10)) -->
<!-- ``` -->

<!-- Also a quote using `>`: -->

<!-- > "He who gives up [code] safety for [code] speed deserves neither." -->
<!-- ([via](https://twitter.com/hadleywickham/status/504368538874703872)) -->
